name: Deploy-Production

on:
  workflow_dispatch:
  release:
    types: [published]

jobs:
  notify_approval:
    runs-on: ubuntu-latest
    steps:
      - name: Notify Slack
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          RELEASE_BODY: ${{ github.event.release.body }}
        run: |
          jq -n \
            --arg body "$RELEASE_BODY" \
            --arg ref "${{ github.ref_name }}" \
            --arg url "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
            --arg commit_url "${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}" \
            --arg commit_sha "${{ github.sha }}" \
            '{text: "Production deployment for *\($ref)* requires approval.\n\n*Release Notes:*\n\($body)\n\nCommit: <\($commit_url)|\($commit_sha)>\n\nPlease verify this commit is deployed on Staging.\n<\($url)|Approve Deployment>"}' > payload.json

          curl -X POST -H 'Content-type: application/json' -d @payload.json $SLACK_WEBHOOK_URL

  deploy_production:
    needs: notify_approval
    runs-on: ubuntu-latest
    environment:
      name: production
    steps:
      - run: echo deploy production
      - run: echo "PROD!!"
